<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TÃ¤gliche Dokumentation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }

        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .chart-container {
            position: relative;
            height: 40vh;
            width: 100%;
        }

        .tag-button {
            transition: all 0.2s ease-in-out;
            color: white;
        }

        .tag-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }

        #notification {
            transition: opacity 0.5s, transform 0.5s;
        }

        .nav-arrow {
            cursor: pointer;
            transition: transform 0.1s;
        }

        .nav-arrow:hover {
            transform: scale(1.2);
        }

        #main-content-panel {
            transition: background-color 0.5s ease;
        }

        .autocomplete-suggestions {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            background-color: white;
            position: absolute;
            z-index: 10;
            width: 100%;
        }

        .autocomplete-suggestion {
            padding: 8px;
            cursor: pointer;
        }

        .autocomplete-suggestion:hover {
            background-color: #f0f0f0;
        }

        .tag-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 9999px;
            font-size: 0.875rem;
            color: white;
            margin-right: 4px;
            margin-bottom: 4px;
        }

        .tag-badge-remove {
            margin-left: 6px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>

<body class="text-gray-800">

    <div id="notification"
        class="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg transform translate-x-full opacity-0 z-50">
    </div>

    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-bold text-gray-900">TÃ¤gliche Dokumentation</h1>
            <p class="text-lg text-gray-600 mt-2">Erfasse und analysiere deine tÃ¤glichen AktivitÃ¤ten.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-1 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">Steuerung</h2>
                    <div class="space-y-4">
                        <div>
                            <label for="date-picker" class="block text-sm font-medium text-gray-700">Datum
                                auswÃ¤hlen</label>
                            <input type="date" id="date-picker"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <div>
                            <label for="status-select"
                                class="block text-sm font-medium text-gray-700">Tagesstatus</label>
                            <select id="status-select"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                                <option value="dokumentiert">Dokumentiert âœ”</option>
                                <option value="urlaub">Urlaub ðŸŒ´</option>
                                <option value="krank">Krank ðŸ¤’</option>
                                <option value="abwesend">Abwesend ðŸš¶</option>
                            </select>
                        </div>
                        <div>
                            <label for="work-hours" class="block text-sm font-medium text-gray-700">Arbeitssollzeit
                                (Stunden)</label>
                            <input type="number" id="work-hours" value="8" min="0" max="24" step="0.25"
                                class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                        </div>
                        <div class="border-t pt-4">
                            <label class="block text-sm font-medium text-gray-700">Zeiterfassung</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="time" id="start-time"
                                    class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                                <span>-</span>
                                <input type="time" id="end-time"
                                    class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                                <button type="button" id="calculate-time-btn"
                                    class="bg-blue-500 hover:bg-blue-600 text-white font-bold p-2 rounded-lg text-sm">Berechnen</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">Berichte</h2>
                    <div class="space-y-2">
                        <button type="button" id="generate-week-report"
                            class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">Wochenbericht</button>
                        <button type="button" id="generate-month-report"
                            class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg">Monatsbericht</button>
                        <button type="button" id="generate-all-report"
                            class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">Gesamtbericht</button>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div id="main-content-panel" class="bg-white p-6 rounded-xl shadow-md">
                    <div class="flex justify-between items-center border-b pb-2 mb-4">
                        <div class="flex items-center gap-4">
                            <svg id="prev-day-btn" xmlns="http://www.w3.org/2000/svg"
                                class="h-6 w-6 text-gray-600 hover:text-indigo-600 nav-arrow" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M15 19l-7-7 7-7" />
                            </svg>
                            <h2 class="text-2xl font-bold text-center">Eintrag fÃ¼r <span
                                    id="current-date-display"></span></h2>
                            <svg id="next-day-btn" xmlns="http://www.w3.org/2000/svg"
                                class="h-6 w-6 text-gray-600 hover:text-indigo-600 nav-arrow" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M9 5l7 7-7 7" />
                            </svg>
                        </div>
                        <div class="text-right">
                            <p class="text-lg font-semibold">Gesamt: <span id="total-hours">0</span>h</p>
                        </div>
                    </div>
                    <div id="daily-entries-container" class="space-y-4 mb-4"></div>
                    <div class="mt-6 flex justify-between items-center">
                        <button type="button" id="add-entry-btn"
                            class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">+ Eintrag
                            hinzufÃ¼gen</button>
                        <button type="button" id="save-day-btn"
                            class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg text-lg">Tag
                            speichern</button>
                    </div>
                </div>
                <div id="tag-library-container" class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-bold mb-4 border-b pb-2">Tag-Bibliothek</h2>
                    <div id="tag-library" class="flex flex-wrap gap-2 mb-4"></div>
                    <div class="space-y-2">
                        <input type="text" id="new-tag-input" placeholder="Name des neuen Tags"
                            class="block w-full rounded-md border-gray-300 shadow-sm p-2">
                        <div class="flex gap-2">
                            <select id="new-tag-category"
                                class="flex-grow block w-full rounded-md border-gray-300 shadow-sm p-2"></select>
                            <button type="button" id="add-new-tag-btn"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">+</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mt-8 bg-white p-6 rounded-xl shadow-md">
            <h2 class="text-xl font-bold mb-4 border-b pb-2">Diagramm-Ansicht</h2>
            <div class="flex items-center gap-4 mb-4">
                <label><input type="radio" name="diagram-view" value="week" checked class="mr-1">Wochenansicht</label>
                <label><input type="radio" name="diagram-view" value="day" class="mr-1">Tagesansicht</label>
            </div>
            <div id="diagram-controls">
                <div id="week-view-controls">
                    <label for="diagram-week-picker">Kalenderwoche</label>
                    <input type="week" id="diagram-week-picker"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
                <div id="day-view-controls" class="hidden">
                    <label for="diagram-day-picker">Tag</label>
                    <input type="date" id="diagram-day-picker"
                        class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2">
                </div>
            </div>
        </div>
        <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 id="bar-chart-title" class="text-xl font-bold mb-4">TÃ¤tigkeiten</h2>
                <div class="chart-container"><canvas id="bar-chart"></canvas></div>
            </div>
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 id="radar-chart-title" class="text-xl font-bold mb-4">Kategorien</h2>
                <div class="chart-container"><canvas id="radar-chart"></canvas></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // --- Globale Variablen & Konstanten ---
            let appData = {};
            let tagCategoryMap = {};
            let barChart, radarChart;
            const CATEGORIES = ['Technik', 'Analyse', 'Dokumentation', 'Organisation', 'Soziales', 'Sonstiges'];
            const RADAR_CATEGORIES = ['Technik', 'Analyse', 'Dokumentation', 'Organisation', 'Soziales']; // Ohne "Sonstiges"
            const CATEGORY_BACKGROUND_COLORS = {
                'Technik': 'rgba(239, 68, 68, 0.1)', 'Analyse': 'rgba(59, 130, 246, 0.1)',
                'Dokumentation': 'rgba(245, 158, 11, 0.1)', 'Organisation': 'rgba(16, 185, 129, 0.1)',
                'Soziales': 'rgba(139, 92, 246, 0.1)', 'Sonstiges': 'rgba(107, 114, 128, 0.1)'
            };
            const CATEGORY_CHART_COLORS = {
                'Technik': 'rgba(239, 68, 68, 0.8)', 'Analyse': 'rgba(59, 130, 246, 0.8)',
                'Dokumentation': 'rgba(245, 158, 11, 0.8)', 'Organisation': 'rgba(16, 185, 129, 0.8)',
                'Soziales': 'rgba(139, 92, 246, 0.8)', 'Sonstiges': 'rgba(107, 114, 128, 0.8)'
            };
            const DAILY_WORK_HOURS = { 1: 8.25, 2: 8.25, 3: 8.25, 4: 8.25, 5: 7.0, 6: 0, 0: 0 };

            // --- DOM-Elemente ---
            const dom = {
                datePicker: document.getElementById('date-picker'),
                currentDateDisplay: document.getElementById('current-date-display'),
                statusSelect: document.getElementById('status-select'),
                workHoursInput: document.getElementById('work-hours'),
                dailyEntriesContainer: document.getElementById('daily-entries-container'),
                totalHoursEl: document.getElementById('total-hours'),
                saveDayBtn: document.getElementById('save-day-btn'),
                tagLibrary: document.getElementById('tag-library'),
                newTagInput: document.getElementById('new-tag-input'),
                newTagCategorySelect: document.getElementById('new-tag-category'),
                addNewTagBtn: document.getElementById('add-new-tag-btn'),
                notificationEl: document.getElementById('notification'),
                mainContentPanel: document.getElementById('main-content-panel'),
                tagLibraryContainer: document.getElementById('tag-library-container'),
                prevDayBtn: document.getElementById('prev-day-btn'),
                nextDayBtn: document.getElementById('next-day-btn'),
                diagramViewRadios: document.querySelectorAll('input[name="diagram-view"]'),
                weekViewControls: document.getElementById('week-view-controls'),
                dayViewControls: document.getElementById('day-view-controls'),
                diagramWeekPicker: document.getElementById('diagram-week-picker'),
                diagramDayPicker: document.getElementById('diagram-day-picker'),
                barChartTitle: document.getElementById('bar-chart-title'),
                radarChartTitle: document.getElementById('radar-chart-title'),
                startTimeInput: document.getElementById('start-time'),
                endTimeInput: document.getElementById('end-time'),
                calculateTimeBtn: document.getElementById('calculate-time-btn'),
                addEntryBtn: document.getElementById('add-entry-btn'),
            };

            // --- Initialisierung ---
            async function init() {
                await loadDataFromServer();
                initializeDefaultTags();
                populateCategorySelect();
                renderTagLibrary();
                setupEventListeners();
                const today = new Date().toISOString().split('T')[0];
                dom.datePicker.value = today;
                initCharts();
                setInitialDiagramDates();
                loadDay(today);
            }

            function setupEventListeners() {
                dom.datePicker.addEventListener('change', () => loadDay(dom.datePicker.value));
                dom.statusSelect.addEventListener('change', handleStatusChange);
                dom.saveDayBtn.addEventListener('click', saveCurrentDay);
                dom.addNewTagBtn.addEventListener('click', addNewTag);
                dom.newTagInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addNewTag(); });
                dom.prevDayBtn.addEventListener('click', () => changeDay(-1));
                dom.nextDayBtn.addEventListener('click', () => changeDay(1));
                dom.calculateTimeBtn.addEventListener('click', calculateAndApplyWorkTime);
                dom.addEntryBtn.addEventListener('click', () => renderDailyEntry());
                document.getElementById('generate-week-report').addEventListener('click', () => handleGenerateReport('week'));
                document.getElementById('generate-month-report').addEventListener('click', () => handleGenerateReport('month'));
                document.getElementById('generate-all-report').addEventListener('click', () => handleGenerateReport('all'));
                dom.diagramViewRadios.forEach(radio => radio.addEventListener('change', handleDiagramViewChange));
                dom.diagramWeekPicker.addEventListener('change', updateCharts);
                dom.diagramDayPicker.addEventListener('change', updateCharts);
            }

            // --- Benachrichtigungen ---
            function showNotification(message, isError = false) {
                dom.notificationEl.textContent = message;
                dom.notificationEl.classList.toggle('bg-green-500', !isError);
                dom.notificationEl.classList.toggle('bg-red-500', isError);
                dom.notificationEl.classList.remove('opacity-0', 'translate-x-full');
                setTimeout(() => { dom.notificationEl.classList.add('opacity-0', 'translate-x-full'); }, 3000);
            }

            // --- Datenmanagement (Server) ---
            async function loadDataFromServer() {
                try {
                    const response = await fetch('/load');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    appData = data.appData || {};
                    tagCategoryMap = data.tagCategoryMap || {};
                } catch (e) {
                    showNotification("Keine Verbindung zum Server.", true);
                }
            }
            async function saveDataToServer() {
                try {
                    const response = await fetch('/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ appData, tagCategoryMap }),
                    });
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    showNotification("Daten gespeichert!", false);
                } catch (e) {
                    showNotification("Speichern fehlgeschlagen.", true);
                }
            }

            // --- Initialisierungs-Helfer ---
            function initializeDefaultTags() {
                const defaultTags = {
                    'Messen': 'Technik', 'Programmieren': 'Technik', 'Simuliert': 'Analyse', 'Analysieren': 'Analyse',
                    'Berechnen (Herleiten)': 'Analyse', 'Lesen von Dokumenten': 'Analyse', 'Dokumentieren': 'Dokumentation',
                    'Tabellen ausfÃ¼llen': 'Dokumentation', 'Bachelorarbeit schreiben': 'Dokumentation',
                    'Planung': 'Organisation', 'Meetings': 'Organisation', 'System einrichten': 'Organisation', 'Orga': 'Dokumentation',
                    'Soziales': 'Soziales', 'Mitarbeiter gesprÃ¤ch': 'Soziales'
                };
                for (const [tag, category] of Object.entries(defaultTags)) {
                    if (!tagCategoryMap[tag]) tagCategoryMap[tag] = category;
                }
            }
            function populateCategorySelect() {
                dom.newTagCategorySelect.innerHTML = CATEGORIES.map(cat => `<option value="${cat}">${cat}</option>`).join('');
            }

            // --- Tageslogik & UI ---
            function changeDay(offset) {
                const currentDate = new Date(dom.datePicker.value + 'T00:00:00');
                currentDate.setDate(currentDate.getDate() + offset);
                dom.datePicker.value = currentDate.toISOString().split('T')[0];
                loadDay(dom.datePicker.value);
            }

            function loadDay(dateString) {
                dom.currentDateDisplay.textContent = new Date(dateString + 'T00:00:00').toLocaleDateString('de-DE', { weekday: 'long', day: 'numeric', month: 'long' });
                dom.dailyEntriesContainer.innerHTML = '';

                const dayOfWeek = new Date(dateString + 'T00:00:00').getDay();
                const defaultWorkHours = DAILY_WORK_HOURS[dayOfWeek];
                const dayData = appData[dateString] || { status: 'dokumentiert', workHours: defaultWorkHours, entries: [] };

                // Datenmigration: Altes Format (tags) auf neues (entries) umwandeln
                if (dayData.tags && !dayData.entries) {
                    dayData.entries = dayData.tags.map(tag => ({
                        tagNames: [tag.name],
                        time: tag.time,
                        note: tag.note
                    }));
                    delete dayData.tags;
                }

                if (!appData[dateString]) dayData.workHours = defaultWorkHours;

                appData[dateString] = dayData;
                dom.statusSelect.value = dayData.status;
                dom.workHoursInput.value = dayData.workHours;

                (dayData.entries || []).forEach(entry => renderDailyEntry(entry));
                if ((dayData.entries || []).length === 0) renderDailyEntry();

                updateTotals();
                handleStatusChange();
                updateCharts();
            }

            function saveCurrentDay() {
                const dateString = dom.datePicker.value;
                const dailyEntries = [];
                dom.dailyEntriesContainer.querySelectorAll('.daily-entry-item').forEach(item => {
                    const tagNames = Array.from(item.querySelectorAll('.tag-badge')).map(badge => badge.dataset.tagName);
                    const time = parseFloat(item.querySelector('.entry-time-input').value) || 0;
                    const note = item.querySelector('.entry-note-input').value.trim();
                    if (tagNames.length > 0 || note) {
                        dailyEntries.push({ tagNames, time, note });
                    }
                });
                appData[dateString] = {
                    status: dom.statusSelect.value,
                    workHours: parseFloat(dom.workHoursInput.value) || 8,
                    entries: dailyEntries,
                };
                saveDataToServer();
                updateCharts();
            }

            function handleStatusChange() {
                const isDocumented = dom.statusSelect.value === 'dokumentiert';
                dom.mainContentPanel.style.opacity = isDocumented ? '1' : '0.5';
                dom.mainContentPanel.querySelectorAll('input, textarea, button, select').forEach(el => el.disabled = !isDocumented);
                dom.saveDayBtn.disabled = false;
                dom.tagLibraryContainer.style.opacity = isDocumented ? '1' : '0.5';
                updateBackgroundColor();
            }

            // --- Multi-Tag-Eintragslogik ---
            function renderDailyEntry(entry = { tagNames: [], time: 0, note: '' }) {
                const entryEl = document.createElement('div');
                entryEl.className = 'daily-entry-item p-3 rounded-lg bg-gray-50 border border-gray-200';

                entryEl.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="flex-grow">
                            <div class="selected-tags-container flex flex-wrap items-center"></div>
                            <div class="relative mt-2">
                                <input type="text" class="tag-search-input w-full rounded-md border-gray-300 shadow-sm p-1.5" placeholder="+ Tag hinzufÃ¼gen...">
                                <div class="autocomplete-suggestions hidden"></div>
                            </div>
                        </div>
                        <div class="flex items-center">
                            <input type="number" value="${entry.time || 0}" min="0" step="0.25" class="entry-time-input w-20 text-center rounded-md border-gray-300 shadow-sm p-1">
                            <span class="text-gray-500 ml-1">h</span>
                            <button type="button" class="remove-entry-btn text-red-500 hover:text-red-700 font-bold text-xl ml-2">&times;</button>
                        </div>
                    </div>
                    <div class="mt-2">
                        <input type="text" class="entry-note-input block w-full rounded-md border-gray-200 shadow-sm p-1.5" placeholder="Notiz fÃ¼r diesen Eintrag..." value="${entry.note || ''}">
                    </div>
                `;

                const tagsContainer = entryEl.querySelector('.selected-tags-container');
                (entry.tagNames || []).forEach(tagName => {
                    tagsContainer.appendChild(createTagBadge(tagName, entryEl));
                });

                setupEntryEventListeners(entryEl);
                dom.dailyEntriesContainer.appendChild(entryEl);
            }

            function setupEntryEventListeners(entryEl) {
                entryEl.querySelector('.entry-time-input').addEventListener('input', updateTotals);
                entryEl.querySelector('.remove-entry-btn').addEventListener('click', () => {
                    if (dom.dailyEntriesContainer.children.length > 1) {
                        entryEl.remove();
                        updateTotals();
                    } else {
                        showNotification("Der letzte Eintrag kann nicht gelÃ¶scht werden.", true);
                    }
                });

                const searchInput = entryEl.querySelector('.tag-search-input');
                const suggestionsContainer = entryEl.querySelector('.autocomplete-suggestions');

                searchInput.addEventListener('input', () => handleTagAutocomplete(searchInput, suggestionsContainer, entryEl));
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && searchInput.value.trim()) {
                        e.preventDefault();
                        const newTagName = searchInput.value.trim();
                        if (tagCategoryMap[newTagName]) {
                            addTagToEntry(newTagName, entryEl);
                            searchInput.value = '';
                            suggestionsContainer.classList.add('hidden');
                        } else {
                            showNotification(`Tag "${newTagName}" nicht in Bibliothek gefunden.`, true);
                        }
                    }
                });

                document.addEventListener('click', (e) => {
                    if (!entryEl.contains(e.target)) suggestionsContainer.classList.add('hidden');
                });
            }

            function handleTagAutocomplete(input, suggestionsContainer, entryEl) {
                const query = input.value.toLowerCase();
                suggestionsContainer.innerHTML = '';
                if (!query) {
                    suggestionsContainer.classList.add('hidden');
                    return;
                }

                const existingTags = Array.from(entryEl.querySelectorAll('.tag-badge')).map(b => b.dataset.tagName);
                const filteredTags = Object.keys(tagCategoryMap)
                    .filter(tag => tag.toLowerCase().includes(query) && !existingTags.includes(tag))
                    .slice(0, 5);

                if (filteredTags.length > 0) {
                    filteredTags.forEach(tag => {
                        const suggestionEl = document.createElement('div');
                        suggestionEl.className = 'autocomplete-suggestion';
                        suggestionEl.textContent = tag;
                        suggestionEl.onclick = () => {
                            addTagToEntry(tag, entryEl);
                            input.value = '';
                            suggestionsContainer.classList.add('hidden');
                        };
                        suggestionsContainer.appendChild(suggestionEl);
                    });
                    suggestionsContainer.classList.remove('hidden');
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
            }

            function addTagToEntry(tagName, entryEl) {
                const tagsContainer = entryEl.querySelector('.selected-tags-container');
                const existingTags = Array.from(tagsContainer.querySelectorAll('.tag-badge')).map(b => b.dataset.tagName);
                if (!existingTags.includes(tagName)) {
                    tagsContainer.appendChild(createTagBadge(tagName, entryEl));
                    updateTotals();
                }
            }

            function createTagBadge(tagName, entryEl) {
                const badge = document.createElement('div');
                badge.className = 'tag-badge';
                badge.textContent = tagName;
                badge.dataset.tagName = tagName;
                const category = tagCategoryMap[tagName];
                badge.style.backgroundColor = CATEGORY_CHART_COLORS[category] || '#6B7280';

                const removeBtn = document.createElement('span');
                removeBtn.className = 'tag-badge-remove';
                removeBtn.innerHTML = '&times;';
                removeBtn.onclick = () => {
                    badge.remove();
                    updateTotals();
                };
                badge.appendChild(removeBtn);
                return badge;
            }

            function updateTotals() {
                const total = Array.from(dom.dailyEntriesContainer.querySelectorAll('.entry-time-input'))
                    .reduce((sum, input) => sum + (parseFloat(input.value) || 0), 0);
                dom.totalHoursEl.textContent = total.toFixed(2);
                updateBackgroundColor();
            }

            function updateBackgroundColor() {
                const categoryHours = CATEGORIES.reduce((acc, cat) => ({ ...acc, [cat]: 0 }), {});
                dom.dailyEntriesContainer.querySelectorAll('.daily-entry-item').forEach(item => {
                    const time = parseFloat(item.querySelector('.entry-time-input').value) || 0;
                    const tags = item.querySelectorAll('.tag-badge');
                    if (tags.length > 0) {
                        const timePerTag = time / tags.length;
                        tags.forEach(badge => {
                            const category = tagCategoryMap[badge.dataset.tagName];
                            if (category) categoryHours[category] += timePerTag;
                        });
                    }
                });

                let dominantCategory = null;
                let maxHours = 0;
                for (const [cat, hours] of Object.entries(categoryHours)) {
                    if (hours > maxHours) {
                        maxHours = hours;
                        dominantCategory = cat;
                    }
                }

                if (dominantCategory && dom.statusSelect.value === 'dokumentiert') {
                    dom.mainContentPanel.style.backgroundColor = CATEGORY_BACKGROUND_COLORS[dominantCategory];
                } else {
                    dom.mainContentPanel.style.backgroundColor = '#ffffff';
                }
            }

            // --- Tag-Bibliothek ---
            function renderTagLibrary() {
                dom.tagLibrary.innerHTML = '';
                Object.keys(tagCategoryMap).sort().forEach(tag => {
                    const button = document.createElement('button');
                    button.setAttribute('type', 'button');
                    button.textContent = tag;
                    const category = tagCategoryMap[tag];
                    button.style.backgroundColor = CATEGORY_CHART_COLORS[category] || '#6B7280';
                    button.title = `Kategorie: ${category}`;
                    button.className = 'tag-button text-sm font-medium py-1 px-3 rounded-full';
                    dom.tagLibrary.appendChild(button);
                });
            }

            function addNewTag() {
                const tagName = dom.newTagInput.value.trim();
                if (tagName && !tagCategoryMap[tagName]) {
                    tagCategoryMap[tagName] = dom.newTagCategorySelect.value;
                    renderTagLibrary();
                    saveDataToServer();
                    showNotification(`Tag "${tagName}" hinzugefÃ¼gt.`);
                    dom.newTagInput.value = '';
                } else if (tagName) {
                    showNotification(`Tag "${tagName}" existiert bereits.`, true);
                }
            }

            // --- Zeitberechnung ---
            function calculateAndApplyWorkTime() {
                if (!dom.startTimeInput.value || !dom.endTimeInput.value) return;
                const start = new Date(`1970-01-01T${dom.startTimeInput.value}`);
                const end = new Date(`1970-01-01T${dom.endTimeInput.value}`);
                if (end <= start) return;
                const diffHours = (end - start) / 3600000;
                dom.workHoursInput.value = diffHours.toFixed(2);

                const entries = dom.dailyEntriesContainer.querySelectorAll('.daily-entry-item');
                if (entries.length > 0) {
                    const timePerEntry = diffHours / entries.length;
                    entries.forEach(entry => entry.querySelector('.entry-time-input').value = timePerEntry.toFixed(2));
                    updateTotals();
                }
            }

            // --- Diagramme & Berichte ---
            function getWeekNumber(d) {
                d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
                d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
                var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
                var weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
                return [d.getUTCFullYear(), weekNo];
            }

            function setInitialDiagramDates() {
                const today = new Date();
                const [year, week] = getWeekNumber(today);
                dom.diagramWeekPicker.value = `${year}-W${String(week).padStart(2, '0')}`;
                dom.diagramDayPicker.value = today.toISOString().split('T')[0];
            }

            function handleDiagramViewChange() {
                const isWeekView = dom.diagramViewRadios[0].checked;
                dom.weekViewControls.classList.toggle('hidden', !isWeekView);
                dom.dayViewControls.classList.toggle('hidden', isWeekView);
                updateCharts();
            }

            function initCharts() {
                const barCtx = document.getElementById('bar-chart').getContext('2d');
                barChart = new Chart(barCtx, { type: 'bar', options: { responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } }, plugins: { tooltip: { callbacks: { label: c => `${c.dataset.label}: ${c.formattedValue}h` } } } } });

                const radarCtx = document.getElementById('radar-chart').getContext('2d');
                radarChart = new Chart(radarCtx, {
                    type: 'radar',
                    data: { labels: RADAR_CATEGORIES },
                    options: { responsive: true, maintainAspectRatio: false, scales: { r: { beginAtZero: true, suggestedMax: 4 } } }
                });
            }

            function updateCharts() {
                const isWeekView = dom.diagramViewRadios[0].checked;
                const periodData = getPeriodDataForCharts();
                updateBarChart(periodData, isWeekView);
                updateRadarChart(periodData, isWeekView);
            }

            function getPeriodDataForCharts() {
                const data = {};
                if (dom.diagramViewRadios[0].checked) { // Week view
                    if (!dom.diagramWeekPicker.value) return {};
                    const [year, week] = dom.diagramWeekPicker.value.split('-W').map(Number);
                    const d = new Date(Date.UTC(year, 0, 1 + (week - 1) * 7));
                    const dayOfWeek = d.getUTCDay();
                    const diff = d.getUTCDate() - dayOfWeek + (dayOfWeek === 0 ? -6 : 1);
                    const startDate = new Date(d.setUTCDate(diff));
                    for (let i = 0; i < 7; i++) {
                        const currentDate = new Date(startDate);
                        currentDate.setUTCDate(startDate.getUTCDate() + i);
                        const dateStr = currentDate.toISOString().split('T')[0];
                        data[dateStr] = appData[dateStr] || null;
                    }
                } else { // Day view
                    if (dom.diagramDayPicker.value) data[dom.diagramDayPicker.value] = appData[dom.diagramDayPicker.value] || null;
                }
                return data;
            }

            function updateBarChart(periodData, isWeekView) {
                const newType = isWeekView ? 'bar' : 'pie';
                if (barChart.config.type !== newType) {
                    barChart.destroy();
                    barChart = new Chart(document.getElementById('bar-chart').getContext('2d'), { type: newType, options: { responsive: true, maintainAspectRatio: false, plugins: { tooltip: { callbacks: { label: c => `${c.label}: ${c.formattedValue}h` } } } } });
                }

                if (isWeekView) {
                    dom.barChartTitle.textContent = "TÃ¤tigkeiten pro Tag";
                    const allTags = [...new Set(Object.values(periodData).flatMap(d => d?.entries?.flatMap(e => e.tagNames) || []))];
                    barChart.data.labels = Object.keys(periodData).map(d => new Date(d + 'T00:00:00').toLocaleDateString('de-DE', { weekday: 'short' }));
                    barChart.options.scales = { x: { stacked: true }, y: { stacked: true, beginAtZero: true } };
                    barChart.data.datasets = allTags.map(tag => ({
                        label: tag,
                        data: Object.values(periodData).map(day =>
                            day?.entries?.reduce((sum, entry) => {
                                const time = entry.tagNames.includes(tag) ? (entry.time / entry.tagNames.length) : 0;
                                return sum + time;
                            }, 0) || 0
                        ),
                        backgroundColor: CATEGORY_CHART_COLORS[tagCategoryMap[tag]] || getRandomColor(tag)
                    }));
                } else { // Day View
                    dom.barChartTitle.textContent = "Tagesverteilung";
                    const day = Object.values(periodData)[0];
                    const tagTotals = {};
                    day?.entries?.forEach(entry => {
                        const timePerTag = entry.tagNames.length > 0 ? entry.time / entry.tagNames.length : 0;
                        entry.tagNames.forEach(tn => {
                            tagTotals[tn] = (tagTotals[tn] || 0) + timePerTag;
                        });
                    });
                    barChart.data.labels = Object.keys(tagTotals);
                    barChart.options.scales = {};
                    barChart.data.datasets = [{
                        data: Object.values(tagTotals),
                        backgroundColor: Object.keys(tagTotals).map(tag => CATEGORY_CHART_COLORS[tagCategoryMap[tag]] || getRandomColor(tag))
                    }];
                }
                barChart.update();
            }

            function updateRadarChart(periodData, isWeekView) {
                dom.radarChartTitle.textContent = isWeekView ? "Kategorien-Fokus (Woche, Ã˜ pro Tag)" : "Kategorien-Fokus (Tag)";
                const categoryTotals = RADAR_CATEGORIES.reduce((acc, cat) => ({ ...acc, [cat]: 0 }), {});
                const documentedDays = Object.values(periodData).filter(d => d && d.status === 'dokumentiert');

                documentedDays.forEach(day => {
                    day.entries?.forEach(entry => {
                        entry.tagNames.forEach(tn => {
                            const category = tagCategoryMap[tn];
                            if (category in categoryTotals) { // Nur relevante Kategorien zÃ¤hlen
                                categoryTotals[category] += (entry.time / entry.tagNames.length);
                            }
                        });
                    });
                });

                const radarData = isWeekView
                    ? (documentedDays.length > 0 ? Object.values(categoryTotals).map(t => t / documentedDays.length) : [])
                    : Object.values(categoryTotals);

                radarChart.data.datasets = [{
                    label: isWeekView ? 'Ã˜ Stunden pro Tag' : 'Gesamtstunden',
                    data: radarData,
                    fill: true,
                    backgroundColor: 'rgba(54, 162, 235, 0.2)',
                    borderColor: 'rgb(54, 162, 235)',
                    pointBackgroundColor: RADAR_CATEGORIES.map(cat => CATEGORY_CHART_COLORS[cat]),
                }];
                radarChart.update();
            }

            function getRandomColor(seed) {
                let hash = 0;
                for (let i = 0; i < seed.length; i++) hash = seed.charCodeAt(i) + ((hash << 5) - hash);
                let color = '#';
                for (let i = 0; i < 3; i++) color += ('00' + ((hash >> (i * 8)) & 0xFF).toString(16)).substr(-2);
                return color + 'B3';
            }

            async function handleGenerateReport(periodType) {
                const { data, firstDay, lastDay, reportTitle } = getPeriodDataForReport(dom.datePicker.value, periodType);
                if (!firstDay || !lastDay || Object.keys(data).length === 0) {
                    showNotification("Keine Daten fÃ¼r den Bericht vorhanden.", true); return;
                }

                let dailyDetailsHtml = '';
                Object.keys(data).sort().forEach(date => {
                    const dayData = data[date];
                    const dayDate = new Date(date + 'T00:00:00');
                    dailyDetailsHtml += `<div class="mb-6 p-4 border rounded-lg break-inside-avoid"><h3 class="text-xl font-bold">${dayDate.toLocaleDateString('de-DE', { weekday: 'long', day: '2-digit', month: '2-digit', year: 'numeric' })}</h3>`;
                    if (!dayData || dayData.status !== 'dokumentiert') {
                        const statusText = dayData ? { urlaub: 'Urlaub', krank: 'Krank', abwesend: 'Abwesend' }[dayData.status] : 'Kein Eintrag';
                        dailyDetailsHtml += `<p class="text-gray-500 italic">${statusText}</p>`;
                    } else {
                        dailyDetailsHtml += '<ul class="list-disc list-inside">';
                        dayData.entries?.forEach(entry => {
                            if (entry.time > 0) {
                                dailyDetailsHtml += `<li><strong>${entry.tagNames.join(', ')}:</strong> ${entry.time}h`;
                                if (entry.note) dailyDetailsHtml += `<div class="pl-6 text-sm text-gray-600">${entry.note}</div>`;
                                dailyDetailsHtml += `</li>`;
                            }
                        });
                        dailyDetailsHtml += '</ul>';
                    }
                    dailyDetailsHtml += `</div>`;
                });

                const reportHtml = `
                    <!DOCTYPE html><html lang="de"><head><meta charset="UTF-8"><title>${reportTitle}</title>
                    <script src="https://cdn.tailwindcss.com/"><\/script><style>body{font-family:sans-serif} @media print{.no-print{display:none}}</style></head>
                    <body class="bg-gray-100 p-8"><div class="max-w-4xl mx-auto bg-white p-10 rounded-lg shadow-lg">
                    <button type="button" onclick="window.print()" class="no-print fixed top-4 right-4 bg-blue-500 text-white py-2 px-4 rounded">Drucken</button>
                    <h1 class="text-4xl font-bold text-center mb-2">${reportTitle}</h1>
                    <p class="text-center text-gray-600 text-lg mb-8">${new Date(firstDay).toLocaleDateString('de-DE')} - ${new Date(lastDay).toLocaleDateString('de-DE')}</p>
                    <h2 class="text-2xl font-bold mt-10 mb-4 border-b pb-2">Tagesdetails</h2>
                    ${dailyDetailsHtml}</div></body></html>`;

                const reportWindow = window.open('', '_blank');
                reportWindow.document.write(reportHtml);
                reportWindow.document.close();
            }

            function getPeriodDataForReport(baseDate, periodType) {
                let startDate, endDate;
                const base = new Date(baseDate + 'T00:00:00');
                if (periodType === 'week') {
                    const day = base.getDay();
                    startDate = new Date(new Date(base).setDate(base.getDate() - day + (day === 0 ? -6 : 1)));
                    endDate = new Date(new Date(startDate).setDate(startDate.getDate() + 6));
                } else if (periodType === 'month') {
                    startDate = new Date(base.getFullYear(), base.getMonth(), 1);
                    endDate = new Date(base.getFullYear(), base.getMonth() + 1, 0);
                } else { // 'all'
                    const allDates = Object.keys(appData).sort();
                    if (allDates.length === 0) return { data: {} };
                    startDate = new Date(allDates[0] + 'T00:00:00');
                    endDate = new Date(allDates[allDates.length - 1] + 'T00:00:00');
                }

                const data = {};
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) {
                    const dateStr = d.toISOString().split('T')[0];
                    if (appData[dateStr]) data[dateStr] = appData[dateStr];
                }
                const titles = { week: 'Wochenbericht', month: 'Monatsbericht', all: 'Gesamtbericht' };
                return { data, firstDay: startDate.toISOString().split('T')[0], lastDay: endDate.toISOString().split('T')[0], reportTitle: titles[periodType] };
            }

            function checkPendingTodos() {
                const pendingTodo = localStorage.getItem('pendingTodo');
                if (pendingTodo) {
                    const todo = JSON.parse(pendingTodo);
                    if (!tagCategoryMap[todo.text]) { tagCategoryMap[todo.text] = 'Sonstiges'; renderTagLibrary(); saveDataToServer(); }
                    renderDailyEntry({ tagNames: [todo.text], time: 0.25, note: 'Aus To-do-Liste Ã¼bernommen' });
                    updateTotals();
                    showNotification(`"${todo.text}" zur Doku hinzugefÃ¼gt.`, false);
                    localStorage.removeItem('pendingTodo');
                }
            }

            // --- App starten ---
            init();
        });
    </script>
</body>

</html>